<!DOCTYPE html>
<html lang="es">
<style>
  /* Estilos para los botones de m√©todos de pago */
.metodo-pago {
    display: none;
}

.btn-check:checked + .btn {
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.5);
    font-weight: bold;
}

.texto-pagos {
    font-size: 0.875rem;
    color: #6c757d;
    margin-top: 5px;
}

/* Limitar a 2 selecciones m√°ximo */
.metodo-pago:checked ~ .metodo-pago:not(:checked) + .btn {
    opacity: 0.5;
    pointer-events: none;
}
  /* Impresi√≥n */
  @media print {
    nav, #btn-pdf, #btn-wsp {
      display: none !important;
    }

    body {
      background-color: white !important;
      color: black;
      font-size: 12pt;
    }

    .card {
      border: 1px solid #ccc;
      margin-bottom: 15px;
      box-shadow: none !important;
    }

    .card-body {
      padding: 10px;
    }

    .card-title {
      font-weight: bold;
      font-size: 14pt;
    }

    .card-text {
      font-size: 12pt;
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 16pt;
    }
  }

  /* Dise√±o general tabla */
  #tabla-pdf {
    font-family: 'Segoe UI', sans-serif;
    margin-top: 15px;
    overflow-x: auto;
  }

  #tabla-pdf table {
    width: 100%;
    border-collapse: collapse;
    background-color: white;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    overflow: hidden;
  }

  #tabla-pdf th {
    background: linear-gradient(90deg, #343a40, #495057);
    color: #ffffff;
    font-weight: 600;
    padding: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border: 1px solid #dee2e6;
  }

  #tabla-pdf td {
    padding: 10px 12px;
    color: #212529;
    font-size: 14px;
    border: 1px solid #dee2e6;
    vertical-align: middle;
    background-color: #ffffff;
  }

  #tabla-pdf tr:hover td {
    background-color: #f1f1f1;
    transition: background-color 0.2s ease-in-out;
  }

  /* Modo oscuro general */
  body.dark-mode {
    background-color: #121212 !important;
    color: #f1f1f1 !important;
  }

  body.dark-mode .navbar {
    background-color: #1f1f1f !important;
  }

  body.dark-mode #toggle-dark {
    background-color: #f8f9fa;
    color: #212529;
  }

  body.dark-mode #tabla-pdf {
    background-color: #1e1e1e;
    color: #f1f1f1;
  }

  body.dark-mode #tabla-pdf th {
    background: linear-gradient(90deg, #2c2c2c, #3c3c3c) !important;
    color: #ffffff;
  }

  body.dark-mode #tabla-pdf td {
    background-color: #2a2a2a;
    color: #ffffff;
  }

  body.dark-mode #tabla-pdf tr:hover td {
    background-color: #3a3a3a;
  }
</style>


<head>
  <meta charset="UTF-8">
  <title>üìÖ Registros de Hoy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

  <!-- üîù Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="/">Zona Biker</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link active" href="/">Inicio</a></li>
          <li class="nav-item"><a class="nav-link" href="/registros-hoy">Registros de Hoy</a></li>
          <li class="nav-item"><a class="nav-link" href="/registros-todos">Todos los Registros</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- üßæ Contenido -->
  <div class="container mt-5">
    <h2 class="text-center mb-4">üìÖ Registros de Hoy</h2>

<div class="text-center mb-4">
  <button class="btn btn-secondary me-2" id="toggle-dark">üåô Modo Oscuro</button>
  <button class="btn btn-danger" id="btn-pdf">üìÑ Descargar PDF</button>
  <a class="btn btn-success ms-2" id="btn-wsp" target="_blank">üì§ Compartir por WhatsApp</a>
  <div class="container mb-4">
  <div class="row justify-content-center">
    <div class="col-md-3">
      <label>Desde:</label>
      <input type="date" id="fechaInicio" class="form-control">
    </div>
    <div class="col-md-3">
      <label>Hasta:</label>
      <input type="date" id="fechaFin" class="form-control">
    </div>
    <div class="col-md-2 d-flex align-items-end">
      <button class="btn btn-primary w-100 me-2" onclick="filtrarPorFechas()">üîé Filtrar</button>
      <button class="btn btn-secondary w-100" onclick="cargarRegistrosHoy()">üîÅ Mostrar Hoy</button>
    </div>
  </div>
</div>

</div>

    <div id="contenedor-registros" class="row gy-4"></div>
<!-- üîΩ Agrega esto despu√©s de contenedor-registros -->
<div id="detalles-empleado" class="mt-4" style="display: none;"></div>

  </div>

  <!-- üîΩ Modal para editar registro -->
<!-- üîΩ Modal para editar registro -->
<div class="modal fade" id="modalEditar" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">‚úèÔ∏è Editar Registro</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="formEditar">
          <input type="hidden" id="edit-id">

          <!-- üìÖ Fecha y Hora -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Fecha</label>
              <input type="date" id="edit-fecha" class="form-control">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Hora</label>
              <input type="time" id="edit-hora" class="form-control">
            </div>
          </div>

          <!-- üë§ Cliente y Tel√©fono -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Cliente</label>
              <input type="text" id="edit-cliente" class="form-control">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Tel√©fono</label>
              <input type="text" id="edit-telefono" class="form-control">
            </div>
          </div>

          <!-- üèçÔ∏è Moto -->
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">Marca</label>
              <input type="text" id="edit-marca" class="form-control">
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Modelo</label>
              <input type="text" id="edit-modelo" class="form-control">
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Cilindrada</label>
              <input type="text" id="edit-cilindrada" class="form-control">
            </div>
          </div>

          <!-- üî¢ Kilometraje y Placa -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Kilometraje</label>
              <input type="number" id="edit-kilometraje" class="form-control">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Placa</label>
              <input type="text" id="edit-placa" class="form-control">
            </div>
          </div>

          <!-- üë®‚Äçüîß Empleado -->
          <div class="mb-3">
            <label class="form-label">Empleado</label>
            <input type="text" id="edit-empleado" class="form-control">
          </div>

          <!-- üîß Servicios -->
          <div class="mb-3">
            <label class="form-label">Servicios</label>
            <textarea id="edit-servicios" class="form-control" rows="2"></textarea>
          </div>

          <!-- üí∞ M√©todos de pago y montos -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">M√©todo de Pago</label>
              <input type="text" id="edit-metodo-pago" class="form-control">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Pago (Costo Total)</label>
              <input type="number" id="edit-costo" class="form-control">
            </div>
          </div>

          <!-- üõ† Mano de obra y Comisi√≥n -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Costo Mano de Obra</label>
              <input type="number" id="edit-costo-mano-obra" class="form-control">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Comisi√≥n</label>
              <input type="number" id="edit-comision" class="form-control" readonly>
            </div>
          </div>

          <!-- üõí Repuesto -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Repuesto</label>
              <input type="text" id="edit-repuesto" class="form-control">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Costo Repuesto</label>
              <input type="number" id="edit-ganancia-repuesto" class="form-control">
            </div>
          </div>

        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="guardarEdicion()">üíæ Guardar cambios</button>
      </div>
    </div>
  </div>
</div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/html2pdf.bundle.min.js"></script>
  <script src="js/registros-hoy.js"></script>
<script>
  document.getElementById('toggle-dark').addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
  });

function mostrarDetallesEmpleado(nombre, fecha) {
  fetch('/api/registros')
    .then(res => res.json())
    .then(registros => {
      const filtrados = registros.filter(r => {
        const fechaR = new Date(r.fecha).toLocaleDateString('es-PE');
        return r.empleado === nombre && fechaR === fecha;
      });

      if (filtrados.length === 0) return;

      let html = `
        <div class="card shadow border border-dark">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="card-title mb-0">üß∞ Motos atendidas por <strong>${nombre}</strong> el ${fecha}</h5>
              <button class="btn btn-sm btn-outline-danger" onclick="cerrarDetallesEmpleado()">‚úñÔ∏è Cerrar</button>
            </div>
            <ul class="list-group list-group-flush">`;

      filtrados.forEach(r => {
        const costo = parseFloat(r.costo) || 0;
        const gananciaRepuesto = parseFloat(r.ganancia_repuesto) || 0;
        const manoObra = costo - gananciaRepuesto;
        const comision = (r.empleado.toLowerCase() === 'kike') ? 0 : manoObra * 0.5;

        html += `
          <li class="list-group-item">
            üõµ <strong>${r.marca} ${r.modelo}</strong><br>
            üìÖ ${fecha} ‚è∞ ${r.hora}<br>
            üë§ Cliente: ${r.cliente} | üî¢ Placa: ${r.placa || '-'}<br>
            üõ† Servicios: ${r.servicios || '-'} | üîß Repuesto: ${r.repuesto || '-'}<br>
            üí∞ Costo: S/${costo.toFixed(2)} | üí≥ Pago: ${r.metodo_pago ?? 'N/A'}<br>
            üì¶ Ganancia Repuesto: S/${gananciaRepuesto.toFixed(2)}<br>
            üî® Mano de Obra: S/${manoObra.toFixed(2)} | üßæ Comisi√≥n: S/${comision.toFixed(2)}
          </li>`;
      });

      html += `
            </ul>
          </div>
        </div>`;

      const detalles = document.getElementById('detalles-empleado');
      detalles.innerHTML = html;
      detalles.style.display = 'block';
      detalles.scrollIntoView({ behavior: 'smooth' });
    });
}

function cerrarDetallesEmpleado() {
  const detalles = document.getElementById('detalles-empleado');
  detalles.innerHTML = '';
  detalles.style.display = 'none';
}
async function filtrarPorFechas() {
  document.getElementById('detalles-empleado').innerHTML = '';
document.getElementById('detalles-empleado').style.display = 'none';
  const inicio = document.getElementById('fechaInicio').value;
  const fin = document.getElementById('fechaFin').value;

  if (!inicio || !fin) {
    alert("üìÖ Por favor selecciona ambas fechas.");
    return;
  }

  const res = await fetch(`/api/registros?desde=${inicio}&hasta=${fin}`);
  const registros = await res.json();

  if (registros.length === 0) {
    document.getElementById('contenedor-registros').innerHTML = `
      <div class="alert alert-warning">‚ùå No hay registros entre ${inicio} y ${fin}.</div>`;
    return;
  }

  // Reutiliza la l√≥gica de cargarRegistrosHoy pero p√°sale los registros filtrados
  renderizarRegistros(registros, `entre ${inicio} y ${fin}`);
}

function renderizarRegistros(registros, fechaTexto) {
  const contenedor = document.getElementById('contenedor-registros');
  if (!registros || registros.length === 0) {
    contenedor.innerHTML = '<div class="alert alert-warning">No hay registros.</div>';
    return;
  }

  let resumenTexto = `üìã *Resumen de lavados - ${fechaTexto}*\nüßº Motos atendidas: ${registros.length}\n\n`;

  let tabla = `
    <div id="tabla-pdf" style="overflow-x:auto; padding: 10px;">
      <h5 class="text-center">Registros ${fechaTexto}</h5>
      <table class="table table-bordered table-hover" style="
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
        text-align: center;
        border: 1px solid #dee2e6;
        background-color: white;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
      ">
        <thead style="background-color: #212529; color: white;">
          <tr>
            <th>Fecha</th><th>Hora</th><th>Cliente</th><th>Moto</th><th>Empleado</th>
            <th>Placa</th><th>Servicios</th><th>Pago</th><th>Costo</th><th>Ganancia Repuesto</th>
            <th>Mano Obra</th><th>Comisi√≥n</th><th>Utilidad (ZonaBiker)</th><th>Repuesto</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody>`;

  const empleados = {};
  let totalGananciaKike = 0;
  let totalGananciaRepuesto = 0;

  registros.forEach(r => {
    const fechaFormateada = new Date(r.fecha).toLocaleDateString('es-PE');
    const empleado = r.empleado || 'Sin nombre';
    const costo = parseFloat(r.costo) || 0;
    const gananciaRepuesto = parseFloat(r.ganancia_repuesto) || 0;
    const manoObra = costo - gananciaRepuesto;
    const mitadManoObra = manoObra * 0.5;

    let comisionEmpleado = 0;
    let gananciaKike = 0;
    if (empleado.toLowerCase() === 'kike') {
      gananciaKike = manoObra;
    } else {
      comisionEmpleado = mitadManoObra;
      gananciaKike = mitadManoObra;
    }

    totalGananciaKike += gananciaKike;
    totalGananciaRepuesto += gananciaRepuesto;

    if (!empleados[empleado]) {
      empleados[empleado] = { cantidad: 0, comision: 0, costos: [], manoObraTotal: 0, utilidad: 0 };
    }

    empleados[empleado].cantidad++;
    empleados[empleado].costos.push(costo);
    empleados[empleado].manoObraTotal += manoObra;
    empleados[empleado].comision += comisionEmpleado;
    empleados[empleado].utilidad += gananciaKike;

    resumenTexto += `üõµ *${r.marca} ${r.modelo}*\nüìÖ ${fechaFormateada} ‚è∞ ${r.hora}\nüë§ Cliente: ${r.cliente}\nüî¢ Placa: ${r.placa || 'No registrada'}\nüë®‚Äçüîß Empleado: ${r.empleado}\nüõ† Servicios: ${r.servicios || 'Ninguno'}\nüîß Repuestos: ${r.repuesto || 'Ninguno'}\nüí≥ Pago: ${r.metodo_pago ?? 'N/A'}\nüí∞ Costo: S/${costo.toFixed(2)}\nüßæ Comisi√≥n: S/${parseFloat(r.comision || comisionEmpleado).toFixed(2)}\nüëë Ganancia Kike: S/${gananciaKike.toFixed(2)}\nüì¶ Ganancia Repuesto: S/${gananciaRepuesto.toFixed(2)}\nüõ† Mano Obra: S/${manoObra.toFixed(2)}\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;

    tabla += `
      <tr>
        <td>${fechaFormateada}</td><td>${r.hora}</td><td>${r.cliente}</td>
        <td>${r.marca} ${r.modelo}</td><td>${r.empleado}</td><td>${r.placa || '-'}</td>
        <td>${r.servicios || '-'}</td><td>${r.metodo_pago ?? 'N/A'}</td>
        <td>S/${costo.toFixed(2)}</td><td>S/${gananciaRepuesto.toFixed(2)}</td>
        <td>S/${manoObra.toFixed(2)}</td><td>S/${comisionEmpleado.toFixed(2)}</td>
        <td>S/${gananciaKike.toFixed(2)}</td><td>${r.repuesto || '-'}</td>
        <td>
          <button class="btn btn-warning btn-sm me-2" onclick="editarRegistro(${r.id})">‚úèÔ∏è</button>
          <button class="btn btn-danger btn-sm" onclick="eliminarRegistro(${r.id})">üóëÔ∏è</button>
        </td>
      </tr>`;
  });

  tabla += '</tbody></table>';

  tabla += `
    <h5 class="mt-4 mb-2">üìä Resumen por trabajador (PDF)</h5>
    <table class="table table-bordered">
      <thead class="table-dark">
        <tr><th>Empleado</th><th>Motos Atendidas</th><th>Costos</th><th>Total Bruto</th><th>Comisi√≥n</th><th>Mano de Obra</th><th>Utilidad</th></tr>
      </thead><tbody>`;

  Object.entries(empleados).forEach(([nombre, data]) => {
    const totalBruto = data.costos.reduce((a, b) => a + b, 0);
    const porcentaje = nombre.toLowerCase() === 'kike' ? 100 : 50;
    tabla += `
      <tr style="cursor: pointer;" onclick='mostrarDetallesEmpleadoFiltrado("${nombre}", ${JSON.stringify(registros)})'>
        <td>${nombre}</td><td>${data.cantidad}</td>
        <td>${data.costos.map((c, i) => `${i + 1}¬∞ S/${c.toFixed(2)}`).join(', ')}</td>
        <td>S/${totalBruto.toFixed(2)}</td><td>(${porcentaje}%) S/${data.comision.toFixed(2)}</td>
        <td>S/${data.manoObraTotal.toFixed(2)}</td><td>S/${data.utilidad.toFixed(2)}</td>
      </tr>`;
  });

  tabla += '</tbody></table></div>';
  tabla += '<div id="detalles-empleado" class="mt-4"></div>';

  const resumenGanancias = `
    <div class="alert alert-success d-flex justify-content-between align-items-center p-3 mb-3 shadow-sm rounded" style="font-size: 16px;">
      <div>
        üëë <strong>Ganancia ZonaBiker:</strong> <span style="font-size: 18px;">S/${totalGananciaKike.toFixed(2)}</span>
      </div>
      <div>
        üì¶ <strong>Ganancia Repuestos:</strong> <span style="font-size: 18px; color: #0d6efd;">S/${totalGananciaRepuesto.toFixed(2)}</span>
      </div>
    </div>`;
    let tituloTabla = document.createElement("h4");
      tituloTabla.className = "text-center mb-3 text-primary";
      tituloTabla.textContent = `üóìÔ∏è Mostrando registros ${fechaTexto}`;
      contenedor.prepend(tituloTabla);

contenedor.innerHTML = resumenGanancias + tabla;
contenedor.insertAdjacentElement("afterbegin", tituloTabla); // ‚úÖ m√°s seguro


  // PDF bot√≥n
  document.getElementById('btn-pdf').addEventListener('click', () => {
    const contenido = document.getElementById('tabla-pdf');
    const opt = {
      margin: [0.3, 0.3, 0.3, 0.3],
      filename: `registros-${fechaTexto}.pdf`,
      image: { type: 'jpeg', quality: 1 },
      html2canvas: { scale: 4 },
      jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' }
    };
    html2pdf().set(opt).from(contenido).save();
  });

  // WhatsApp resumen
  document.getElementById('btn-wsp').href =
    `https://wa.me/?text=${encodeURIComponent(resumenTexto)}`;
}


</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('form-registro');
    
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // 1. OBTENER M√âTODOS DE PAGO SELECCIONADOS
        const selectedPayments = Array.from(document.querySelectorAll('.metodo-pago:checked'))
                                    .map(checkbox => checkbox.value);
        
        // Validar que no se seleccionen m√°s de 2 m√©todos
        if (selectedPayments.length > 2) {
            alert('‚ùå M√°ximo 2 m√©todos de pago permitidos');
            return;
        }
        
        const formData = new FormData(form);
        
        // 2. PREPARAR DATOS PARA ENVIAR
        const data = {
            marca: formData.get('marca'),
            modelo: formData.get('modelo'),
            cilindrada: formData.get('cilindrada'),
            kilometraje: formData.get('kilometraje'),
            cliente: formData.get('cliente'),
            telefono: formData.get('telefono'),
            empleado: formData.get('empleado'),
            fecha: formData.get('fecha'),
            hora: formData.get('hora'),
            costo: parseFloat(formData.get('costo')) || 0,
            costo_mano_obra: parseFloat(formData.get('costo_mano_obra')) || 0, // Valor ingresado
            metodo_pago: selectedPayments.join(', '), // M√©todos como string
            servicios: formData.get('servicios'),
            placa: formData.get('placa'),
            repuesto: formData.get('repuesto'),
            ganancia_repuesto: parseFloat(formData.get('ganancia_repuesto')) || 0
        };
        
        console.log('Datos a enviar:', data); // Para debug

        // 3. ENVIAR AL SERVIDOR
        try {
            const response = await fetch('/api/registro', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                alert('‚úÖ Registro guardado correctamente');
                form.reset();
            } else {
                alert('‚ùå Error al guardar registro');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('‚ùå Error de conexi√≥n');
        }
    });

    // ... el resto de tu c√≥digo (autocompletados, etc.) ...
});
</script>
<script>
// Limitar selecci√≥n a m√°ximo 2 m√©todos de pago
document.querySelectorAll('.metodo-pago').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const checked = document.querySelectorAll('.metodo-pago:checked');
        
        if (checked.length > 2) {
            this.checked = false;
            alert('‚ùå M√°ximo 2 m√©todos de pago permitidos');
            return;
        }
        
        // Habilitar/deshabilitar checkboxes seg√∫n la selecci√≥n
        document.querySelectorAll('.metodo-pago').forEach(cb => {
            if (checked.length >= 2 && !cb.checked) {
                cb.disabled = true;
                cb.nextElementSibling.style.opacity = '0.5';
            } else {
                cb.disabled = false;
                cb.nextElementSibling.style.opacity = '1';
            }
        });
    });
});

// Inicializar fecha y hora actual
document.getElementById('fecha').valueAsDate = new Date();
document.getElementById('hora').value = new Date().toTimeString().substring(0, 5);
</script>
</body>
</html>
